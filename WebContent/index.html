<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>海洋科学数据交互式可视化系统</title>
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">

    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <link rel="shortcut icon" href="images/favicon.ico">
    <!-- Cesium将在底部按正确顺序加载 -->

    <link type='text/css' rel='stylesheet' href='ThirdParty/datepicker/dist/css/bootstrap-datepicker.css'>
    <link type='text/css' rel='stylesheet' href='ThirdParty/datepicker/dist/css/calendar.css'>
    <link type='text/css' rel='stylesheet' href='ThirdParty/bootstrap/bootstrap.min.css'>
    <link type='text/css' rel="stylesheet" href="ThirdParty/bootstrap-table/src/bootstrap-table.css">
    <link type='text/css' rel='stylesheet' href="ThirdParty/bootstrapslider/bootstrap-slider.css"/>
    <link type='text/css' rel="stylesheet" href="ThirdParty/fancytree/src/jquery-ui.css"/>
    <link type='text/css' rel='stylesheet' href="ThirdParty/fancytree/src/skin-win8/ui.fancytree.css"
          class="skinswitcher"/>
    <link type='text/css' rel='stylesheet' href="Apps/Sandcastle/templates/bucket.css">
    <link type='text/css' rel='stylesheet' href="css/style.css">
    <link type='text/css' rel='stylesheet' href="css/override_black_backgrounds.css">
    <link type='text/css' rel='stylesheet' href="css/new_panel_layout.css">
    <link type='text/css' rel='stylesheet' href="css/panel_background_fix.css">
    <link type='text/css' rel='stylesheet' href="css/force_panel_layout.css">
    <link type='text/css' rel='stylesheet' href="css/final_panel_fix.css">
    <link type='text/css' rel='stylesheet' href="css/fix_earth_shift.css">


    <style>
        html, body, #cesiumContainer {
            /*position: fixed;*/
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* 强制显示面板的测试样式 */
        #test-panel-btn {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            z-index: 99999 !important;
            padding: 10px !important;
            background: red !important;
            color: white !important;
            border: none !important;
            cursor: pointer !important;
            font-size: 14px !important;
        }
        
        #hide-panel-btn {
            position: fixed !important;
            top: 60px !important;
            left: 10px !important;
            z-index: 99999 !important;
            padding: 10px !important;
            background: blue !important;
            color: white !important;
            border: none !important;
            cursor: pointer !important;
            font-size: 14px !important;
        }
        
        /* 确保面板在active状态下显示 */
        #sidebar-right.active {
            right: 0 !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .sidebar-new.active {
            right: 0 !important;
        }
    </style>

    <script>
        // 航次站点点击函数将由 new_panel_controller.js 提供
        // 备用函数，防止脚本加载延迟
        if (typeof window.openVoyagePanel === 'undefined') {
            window.openVoyagePanel = function() {
                console.log('🚢 使用备用函数打开航次面板');
                // 等待脚本加载完成
                const tryOpen = function() {
                    if (typeof window.openVoyagePanel !== 'undefined' && window.openVoyagePanel !== tryOpen) {
                        window.openVoyagePanel();
                    } else {
                        // 直接操作DOM
                        const panel = document.getElementById('sidebar-right');
                        if (panel) {
                            panel.classList.add('active');
                            panel.style.right = '0px';
                            panel.style.display = 'flex';
                            console.log('✅ 备用函数成功打开面板');
                            
                            // 延迟执行修复
                            setTimeout(() => {
                                if (typeof window.forcePanelContentFix === 'function') {
                                    window.forcePanelContentFix();
                                }
                            }, 200);
                        } else {
                            setTimeout(tryOpen, 100);
                        }
                    }
                };
                tryOpen();
            };
        }
        
        // 其他页面级别的函数
        function poumianclick() {
            console.log('点击了剖面信息');
        }
        
        function dixingclick() {
            console.log('点击了海底地形');
        }
        
        function yangliuclick() {
            console.log('点击了洋流风场');
        }
    </script>

</head>

<body>

<script>
    // 确保函数立即可用
    console.log('🔍 检查测试面板函数:', typeof showTestPanel, typeof hideTestPanel);
    
    // 如果函数未定义，提供备用函数
    if (typeof showTestPanel === 'undefined') {
        window.showTestPanel = function() {
            console.error('❌ showTestPanel 函数未加载，请刷新页面');
            alert('函数未加载，请刷新页面后重试');
        };
    }
    
    if (typeof hideTestPanel === 'undefined') {
        window.hideTestPanel = function() {
            console.error('❌ hideTestPanel 函数未加载，请刷新页面');
        };
    }
</script>

<div class="head">
    <div id="titlebg"></div>
    <div id="ship"></div>

    <div class="nav-button1" onclick='openVoyagePanel()' style="cursor: pointer;"></div>
    <div class="nav-title1">航次站点</div>

    <div class="nav-button2" onclick='poumianclick()'></div>
    <div class="nav-title2">剖面信息</div>

    <div class="nav-button3" onclick='dixingclick()'></div>
    <div class="nav-title3">海底地形</div>

    <div class="nav-button4" onclick='yangliuclick()'></div>
    <div class="nav-title4">洋流风场</div>

    <div class="nav-button5" onclick="window.open('http://msdc.qdio.ac.cn/')"></div>
    <div class="nav-title5">数据中心</div>

    <div>
        <label
                id="idCoorInfo" class="coorInfo">
        </label>
    </div>

</div>

<main>

    <div class="earthContainer">
        <div class="slogan">
            <p>
                中国科学院战略性先导科技专项(A类)<br>"热带西太平洋海洋系统物质能量交换及其影响"
            </p>

        </div>

        <div id="2D" class='map2d'></div>
        <div id="3D" class='map3d'></div>


        <!-- 全新设计的右侧面板 -->
        <div class='sidebar-new' id='sidebar-right' style="position: fixed !important; top: 125px !important; right: -450px !important; width: 450px !important; height: calc(100vh - 125px) !important; background-color: #ffffff !important; background: #ffffff !important; border-left: 2px solid #ddd !important; z-index: 9999 !important; display: flex !important; flex-direction: column !important; transform: none !important; transition: right 0.3s ease !important; box-shadow: -5px 0 15px rgba(0,0,0,0.3) !important;">
            <!-- 内容区域 -->
            <div class='content-area' style="flex: 1 !important; background-color: #ffffff !important; background: #ffffff !important; position: relative !important;">
                <!-- 航次内容 -->
                <div class='content-panel active' id='voyage-content' style="position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; display: flex !important; flex-direction: column !important; background-color: #ffffff !important; background: #ffffff !important;">
                    <!-- 子标签页 -->
                    <div class='sub-tabs'>
                        <div class='sub-tab active' id='voyage-query-tab' data-target='voyage-query-content'>航次查询</div>
                        <div class='sub-tab' id='voyage-info-tab' data-target='voyage-info-content'>航次信息</div>
                        <div class='sub-tab' id='station-info-tab' data-target='station-info-content'>站点信息</div>
                    </div>
                    
                    <!-- 航次查询内容 -->
                    <div class='sub-content active' id='voyage-query-content' style="display: block !important; flex: 1 !important; padding: 15px !important; background-color: #ffffff !important; background: #ffffff !important;">
                        <div class='content-section'>
                            <div class='section-header'>查询结果</div>
                            <div class='table-container'>
                                <table class='data-table' id='tblVoyageList'>
                                    <thead>
                                        <tr>
                                            <th width="50">编号</th>
                                            <th>航次名称</th>
                                            <th width="80">海域</th>
                                            <th width="100">调查时间</th>
                                        </tr>
                                    </thead>
                                    <tbody id='tbodyVoyageList'>
                                        <tr>
                                            <td colspan="4" class="empty-state">
                                                <div class="empty-message">
                                                    <i class="icon-ship"></i>
                                                    <p>请选择航次类别并点击查询按钮</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class='pagination-controls'>
                                <button class='page-btn' id='voyPre' onclick='voyPagePrevious()'>‹</button>
                                <button class='page-btn' id='voyNext' onclick='voyPageNext()'>›</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 航次信息内容 -->
                    <div class='sub-content' id='voyage-info-content'>
                        <div class='content-section'>
                            <div class='section-header'>基本信息</div>
                            <div class='info-table'>
                                <div class='info-row'>
                                    <div class='info-label'>航次编号:</div>
                                    <div class='info-value' id='hangcibianhao'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>航次名称:</div>
                                    <div class='info-value' id='hangcimingcheng'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>开始日期:</div>
                                    <div class='info-value' id='kaishiriqi'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>结束日期:</div>
                                    <div class='info-value' id='jieshuriqi'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>首席科学家:</div>
                                    <div class='info-value' id='kexuejia'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>调查海区:</div>
                                    <div class='info-value' id='diaochahaiyu'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>项目编号:</div>
                                    <div class='info-value' id='ketibianhao'>-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class='content-section'>
                            <div class='section-header'>站点列表</div>
                            <div class='table-container'>
                                <table class='data-table' id='tblStationList'>
                                    <thead>
                                        <tr>
                                            <th>站点</th>
                                            <th>经度（度）</th>
                                            <th>纬度（度）</th>
                                            <th>水深（米）</th>
                                        </tr>
                                    </thead>
                                    <tbody id='tbodyStationList'>
                                        <tr>
                                            <td colspan="4" class="empty-state">
                                                <div class="empty-message">
                                                    <p>请先选择航次</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 站点信息内容 -->
                    <div class='sub-content' id='station-info-content'>
                        <div class='content-section'>
                            <div class='section-header'>站点基本信息</div>
                            <div class='info-table'>
                                <div class='info-row'>
                                    <div class='info-label'>编号:</div>
                                    <div class='info-value' id='zhandian'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>经度（度）:</div>
                                    <div class='info-value' id='jingdu'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>纬度（度）:</div>
                                    <div class='info-value' id='weidu'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>水深（米）:</div>
                                    <div class='info-value' id='shuishen'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>日期:</div>
                                    <div class='info-value' id='riqi'>-</div>
                                </div>
                                <div class='info-row'>
                                    <div class='info-label'>航次:</div>
                                    <div class='info-value' id='hangci'>-</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class='content-section'>
                            <div class='section-header'>观测信息</div>
                            <div class='chart-controls'>
                                <select id='yValue' onchange='updateView()'>
                                    <option value='Temperature'>温度</option>
                                    <option value='Salinity'>盐度</option>
                                </select>
                            </div>
                            <div class='chart-container' id='pointChart'></div>
                        </div>
                    </div>
                </div>

                <!-- 其他内容面板 -->
                <div class='content-panel' id='profile-content'>
                    <div class='content-section'>
                        <div class='section-header'>剖面信息</div>
                        <p>剖面信息功能区域</p>
                    </div>
                </div>

                <div class='content-panel' id='terrain-content'>
                    <div class='content-section'>
                        <div class='section-header'>海底地形</div>
                        <p>海底地形功能区域</p>
                    </div>
                </div>

                <div class='content-panel' id='current-content'>
                    <div class='content-section'>
                        <div class='section-header'>流场模拟</div>
                        <p>流场模拟功能区域</p>
                    </div>
                </div>
            </div>
        </div>

        <div class='sidebar-left' id='sidebar-left'>
            <img class='sidebar-left-close' src='images\leftsidebar_close.png' alt='关闭'>

            <div class='tab-content-box'>
                <div class='info-contents-10'>
                    <div class="panel panel-info" style="color:#000000">
                        <div class="panel-heading">航次类别</div>
                        <table class="table table-bg ">

                            <tr>
                                <div id="tree"></div>


                            </tr>

                            <tr>
                                <td style="text-align: left" colspan="2">
                                    <div style='padding-left: 2px ;top: 12px;'>
                                        调查日期： <br/>
                                    </div>

                                </td>
                                <td>
                                    <div class="input-daterange input-group"
                                         id="datepickerHangCiChaXun">
                                        <input type="text" class="input-sm form-control"
                                               style="height: 30px"
                                               name="start" id="startdate" value=""/>
                                        <span class="input-group-addon" style="height: 16px">to</span>
                                        <input type="text" class="input-sm form-control"
                                               style="height: 30px"
                                               name="end" id="enddate" value=""
                                        />
                                    </div>


                                </td>
                            </tr>
                            <tr>
                                <td style="text-align: left;" colspan="2">
                                    <div style='padding-left: 2px;top: 12px'>
                                        热&nbsp;&nbsp;力&nbsp;&nbsp;图： <br/>
                                    </div>

                                </td>
                                <td style="text-align: left">
                                    <div class="checkbox">
                                        <label>
                                            <input id="ckbheatmap" type="checkbox" value="">打开热力图（可选）</label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td style="text-align: center" colspan="3">

                                    <button id="SearchRoute1" class="btn btn-success"
                                    >查询
                                    </button>
                                    <button id="RemoveRoute1" class="btn btn-success"
                                    >清除
                                    </button>

                                </td>
                            </tr>

                        </table>
                    </div>
                </div>


            </div>

        </div>

        <div class="vmap" id="vmap"></div>


        <div id="currentdisplay">
            <div style="display: none">
                - MAP AND TITLE -->

                <div id="map-heading">
                    <span id="title">wind map</span>
                </div>

                <hr id="header-line"/>

                <div id="map-data">
                    <span id="update-time"></span> <br>
                    <br> <span id="average-speed"></span><br>
                    <br>
                </div>
                <div id="legend">
                    <canvas id="legend1" width=80 height=20></canvas>
                    1 mph<br>
                    <br>
                    <canvas id="legend2" width=80 height=20></canvas>
                    3 mph<br>
                    <br>
                    <canvas id="legend3" width=80 height=20></canvas>
                    5 mph<br>
                    <br>
                    <canvas id="legend4" width=80 height=20></canvas>
                    10 mph<br>
                    <br>
                    <canvas id="legend5" width=80 height=20></canvas>
                    15 mph<br>
                    <br>
                    <canvas id="legend6" width=80 height=20></canvas>
                    30 mph<br>
                    <br>
                    <input style="visibility: hidden" id="animating" type="checkbox" checked> </input>
                    <br>
                    <br>
                    <input id="unzoom" style="visibility: hidden" onclick="doUnzoom()" type="button"
                           value="Unzoom"> </input>
                </div>
                <!--<div style="display: none">-->

                <canvas id="display" width=600 height=300 unselectable="on"
                        class="unselectable"> If the map is missing, we recommend the latest
                    <a href="http://www.google.com/chrome">Chrome</a> browser.
                </canvas>

                <canvas id="image-canvas" width=600 height=300 unselectable="on"
                        class="unselectable"></canvas>

                <div id="callout"></div>

            </div>
        </div>
    </div>

</main>


<!-- 第1步：优先加载DWR脚本 -->
<script type='text/javascript' src='./dwr/engine.js'></script>
<script type='text/javascript' src='./dwr/util.js'></script>
<script type='text/javascript' src='./dwr/interface/ServiceJS.js'></script>
<script type='text/javascript' src='./dwr/interface/DatabaseOperationJS.js'></script>

<!-- 第2步：加载Cesium和jQuery -->
<script type='text/javascript' src="Build/Cesium/Cesium.js?v=1.130.20241210"></script>
<script type='text/javascript' src="Apps/Sandcastle/Sandcastle-header.js"></script>
<script type='text/javascript' src="ThirdParty/jquery/jquery.min.js"></script>
<script type='text/javascript' src="ThirdParty/bootstrap/bootstrap.min.js"></script>
<script type='text/javascript' src="ThirdParty/datepicker/dist/js/bootstrap-datepicker.js"></script>
<script type="text/javascript" src="ThirdParty/datepicker/datepickerex.js"></script>
<script type='text/javascript' src='ThirdParty/ECharts/echarts.min.js'></script>
<script type='text/javascript' src="ThirdParty/heatmap/CesiumHeatmap.js"></script>
<script type='text/javascript' src="ThirdParty/fancytree/src/jquery-1.12.1.min.js"></script>
<script type='text/javascript' src="ThirdParty/fancytree/src/jquery-ui.min.js"></script>
<script type='text/javascript' src="ThirdParty/fancytree/src/jquery.fancytree.js"></script>
<script type='text/javascript' src="ThirdParty/fancytree/src/jquery.fancytree.dnd.js"></script>
<script type='text/javascript' src="ThirdParty/fancytree/src/jquery.fancytree.table.js"></script>
<script type='text/javascript' src="ThirdParty/fancytree/src/jquery.fancytree.columnview.js"></script>
<script type='text/javascript' src="ThirdParty/bootstrap-table/src/bootstrap-table.js"></script>
<script type='text/javascript' src="ThirdParty/bootstrapslider/bootstrap-slider.js"></script>

<!-- 立即加载测试面板函数 -->
<script type='text/javascript' src="js/test_panel_functions.js"></script>

<!-- 第3步：等待DWR初始化完成后加载应用脚本 -->
<script type="text/javascript">
function checkDWRAndLoadApp() {
    console.log('检查DWR和依赖库状态...');
    
    // 检查所有必要的依赖
    if (typeof dwr === 'undefined') {
        console.log('等待DWR引擎加载...');
        setTimeout(checkDWRAndLoadApp, 100);
        return;
    }
    
    if (typeof DatabaseOperationJS === 'undefined') {
        console.log('等待DatabaseOperationJS加载...');
        setTimeout(checkDWRAndLoadApp, 100);
        return;
    }
    
    if (typeof Cesium === 'undefined') {
        console.log('等待Cesium加载...');
        setTimeout(checkDWRAndLoadApp, 100);
        return;
    }
    
    if (typeof $ === 'undefined') {
        console.log('等待jQuery加载...');
        setTimeout(checkDWRAndLoadApp, 100);
        return;
    }
    
    console.log('✅ 所有依赖已就绪，开始加载应用脚本...');
    
    // 动态加载应用脚本
    var scripts = [
        'js/initial.js?v=' + Date.now(),
        'js/main.js?v=' + Date.now(),
        'js/new_panel_controller.js?v=' + Date.now(),
        'js/navigation_enhanced.js?v=' + Date.now(),
        'js/panel_fixes_combined.js?v=' + Date.now(),
        'js/debug_panel_content.js?v=' + Date.now(),
        'js/terrain.js?v=' + Date.now(),
        'js/profile.js?v=' + Date.now(),
        'js/stationinfo.js?v=' + Date.now(),
        'js/voyage.js?v=' + Date.now()
    ];
    
    function loadScript(index) {
        if (index >= scripts.length) {
            console.log('✅ 所有应用脚本加载完成');
            return;
        }
        
        var script = document.createElement('script');
        script.src = scripts[index];
        script.onload = function() {
            console.log('✅ 已加载: ' + scripts[index]);
            loadScript(index + 1);
        };
        script.onerror = function() {
            console.error('❌ 加载失败: ' + scripts[index]);
            loadScript(index + 1);
        };
        document.head.appendChild(script);
    }
    
    loadScript(0);
}

// 面板控制函数已移至 js/test_panel_functions.js
// 这里保留注释以供参考

// 关闭箭头事件绑定已移至 js/test_panel_functions.js


// 页面DOM加载完成后开始检查
document.addEventListener('DOMContentLoaded', checkDWRAndLoadApp);

// 立即检查面板元素
setTimeout(() => {
    console.log('🔍 检查面板元素是否存在...');
    const panel = document.getElementById('sidebar-right');
    console.log('面板元素:', panel);
    
    if (panel) {
        console.log('✅ 找到面板元素');
        console.log('面板当前样式 - right:', panel.style.right);
        console.log('面板当前样式 - display:', panel.style.display);
        console.log('面板计算样式 - right:', window.getComputedStyle(panel).right);
        console.log('面板计算样式 - display:', window.getComputedStyle(panel).display);
        
        // 检查子元素
        const contentArea = panel.querySelector('.content-area');
        const voyageContent = panel.querySelector('#voyage-content');
        const queryContent = panel.querySelector('#voyage-query-content');
        
        console.log('内容区域:', contentArea ? '✅' : '❌');
        console.log('航次内容:', voyageContent ? '✅' : '❌');
        console.log('查询内容:', queryContent ? '✅' : '❌');
    } else {
        console.log('❌ 未找到面板元素');
    }
}, 3000);

// 添加调试函数，可以从控制台手动调用
window.debugPanelElements = function() {
    console.log('=== 面板元素调试信息 ===');
    const panel = document.getElementById('sidebar-right');
    console.log('主面板:', panel);
    
    if (panel) {
        console.log('面板样式:', panel.getAttribute('style'));
        console.log('面板类名:', panel.className);
        
        const children = panel.querySelectorAll('*');
        console.log('子元素总数:', children.length);
        
        const contentArea = panel.querySelector('.content-area');
        const voyageContent = panel.querySelector('#voyage-content');
        const queryContent = panel.querySelector('#voyage-query-content');
        const queryTab = panel.querySelector('#voyage-query-tab');
        
        console.log('内容区域:', contentArea);
        console.log('航次内容:', voyageContent);
        console.log('查询内容:', queryContent);
        console.log('查询标签:', queryTab);
    }
};

</script>

</body>
</html>
